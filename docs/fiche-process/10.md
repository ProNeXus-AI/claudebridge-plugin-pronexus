# FICHE 10 ‚Äî Discord Ops & Broadcast Sync‚Ñ¢

## üß© Contexte & Objectif

Int√©gration compl√®te **Discord ‚Üî Claude Bridge** pour diffusion automatique des logs IA-Pirate‚Ñ¢, gestion de commandes slash Discord et synchronisation bidirectionnelle des √©v√©nements. Architecture webhook + bot Discord pour contr√¥le total depuis le serveur ProNeXus‚Ñ¢.

**Finalit√© op√©rationnelle :** Transformer Discord en Command Center IA avec visibilit√© temps r√©el des op√©rations Claude et capacit√© d'orchestration √† distance.

---

## ‚öôÔ∏è Concepts Banger‚Ñ¢

üîπ **Discord Bot Architecture**
Bot ProNeXus‚Ñ¢ avec permissions √©lev√©es (messages, slash commands, threads, embeds).

üîπ **AI-Pirate‚Ñ¢ Logging Protocol**
Format structur√© pour logs d'ex√©cution IA (actions, dur√©es, r√©sultats) dans canal d√©di√©.

üîπ **Slash Command Bridge**
Commandes Discord (`/pnx-execute`, `/pnx-recall`, `/pnx-status`) qui triggent des actions Claude via MCP.

üîπ **Thread-Based Context**
Cr√©ation automatique de threads Discord pour chaque session Claude, permettant historique conversationnel.

üîπ **Webhook Broadcasting**
Diffusion √©v√©nementielle (nouvelle fiche, workflow termin√©, erreur critique) dans canaux sp√©cifiques.

---

## üöÄ Proc√©dure compl√®te

### 1Ô∏è‚É£ Cr√©ation du Bot Discord

**Sur Discord Developer Portal :**

1. Aller sur https://discord.com/developers/applications
2. Cr√©er application "ProNeXus Claude Bridge"
3. Section **Bot** :
   - Activer "Message Content Intent"
   - Activer "Server Members Intent"
   - G√©n√©rer token : `MTxxxxx.xxxxxx.xxxxxxxx`
4. Section **OAuth2 > URL Generator** :
   - Scopes : `bot`, `applications.commands`
   - Permissions : `Send Messages`, `Manage Threads`, `Use Slash Commands`, `Embed Links`
   - Copier URL d'invitation

**Inviter le bot sur le serveur ProNeXus‚Ñ¢.**

### 2Ô∏è‚É£ Configuration du Bot

**Fichier `discord-bot/config.json` :**

```json
{
  "discord": {
    "token": "MTxxxxx.xxxxxx.xxxxxxxx",
    "guild_id": "123456789012345678",
    "channels": {
      "ia_logs": "987654321098765432",
      "command_center": "876543210987654321",
      "notifications": "765432109876543210"
    },
    "roles": {
      "admin": "654321098765432109",
      "dev": "543210987654321098"
    }
  },
  "claude_bridge": {
    "mcp_endpoint": "https://claude.pronexus.local/api/mcp",
    "webhook_url": "https://discord.com/api/webhooks/xxxxx/yyyyy"
  }
}
```

### 3Ô∏è‚É£ Structure des Logs IA-Pirate‚Ñ¢

**Format d'embed Discord :**

```javascript
const createAILogEmbed = (logData) => {
  return {
    embeds: [{
      title: `üè¥‚Äç‚ò†Ô∏è IA-Pirate‚Ñ¢ Log ‚Äî ${logData.action}`,
      color: logData.status === 'success' ? 0x00ff00 : 0xff0000,
      fields: [
        {
          name: "üéØ Action",
          value: logData.action,
          inline: true
        },
        {
          name: "‚è±Ô∏è Dur√©e",
          value: `${logData.duration_ms}ms`,
          inline: true
        },
        {
          name: "üìä Statut",
          value: logData.status === 'success' ? '‚úÖ Succ√®s' : '‚ùå Erreur',
          inline: true
        },
        {
          name: "üîó Session",
          value: `\`${logData.session_id}\``,
          inline: false
        },
        {
          name: "üìù D√©tails",
          value: logData.details || "Aucun d√©tail suppl√©mentaire",
          inline: false
        }
      ],
      footer: {
        text: `ProNeXus‚Ñ¢ Claude Bridge ‚Ä¢ ${new Date().toISOString()}`
      },
      timestamp: new Date().toISOString()
    }]
  };
};
```

**Exemple de log post√© :**

```json
{
  "session_id": "ses_2025-10-30_abc123",
  "action": "notion.create_page",
  "status": "success",
  "duration_ms": 1240,
  "details": "Page 'FICHE 06' cr√©√©e dans base Fiches Process PNX‚Ñ¢",
  "result": {
    "page_id": "abc123def456",
    "url": "https://notion.so/abc123def456"
  }
}
```

### 4Ô∏è‚É£ Impl√©mentation des Slash Commands

**Commande : `/pnx-execute`**

Ex√©cute une action Claude via MCP depuis Discord.

```javascript
// discord-bot/commands/pnx-execute.js
module.exports = {
  data: {
    name: 'pnx-execute',
    description: 'Ex√©cute une action Claude Bridge',
    options: [
      {
        name: 'tool',
        type: 3, // STRING
        description: 'Nom du MCP tool √† ex√©cuter',
        required: true,
        choices: [
          { name: 'Trigger n8n workflow', value: 'trigger_n8n_workflow' },
          { name: 'Publish to Notion', value: 'notion_create_page' },
          { name: 'Get execution logs', value: 'get_execution_logs' }
        ]
      },
      {
        name: 'params',
        type: 3, // STRING
        description: 'Param√®tres JSON',
        required: false
      }
    ]
  },
  async execute(interaction) {
    await interaction.deferReply();

    const tool = interaction.options.getString('tool');
    const params = JSON.parse(interaction.options.getString('params') || '{}');

    try {
      const response = await fetch(`${config.claude_bridge.mcp_endpoint}/execute`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tool, params })
      });

      const result = await response.json();

      await interaction.editReply({
        embeds: [{
          title: `‚úÖ Ex√©cution r√©ussie : ${tool}`,
          color: 0x00ff00,
          description: `\`\`\`json\n${JSON.stringify(result, null, 2)}\n\`\`\``,
          timestamp: new Date().toISOString()
        }]
      });

      // Log dans #ia-logs
      await logToChannel('ia_logs', {
        action: tool,
        status: 'success',
        duration_ms: result.duration_ms,
        triggered_by: interaction.user.tag
      });

    } catch (error) {
      await interaction.editReply({
        embeds: [{
          title: `‚ùå Erreur : ${tool}`,
          color: 0xff0000,
          description: error.message
        }]
      });
    }
  }
};
```

**Commande : `/pnx-recall`**

R√©cup√®re un snapshot de contexte depuis la Memory Sync Core.

```javascript
// discord-bot/commands/pnx-recall.js
module.exports = {
  data: {
    name: 'pnx-recall',
    description: 'R√©cup√®re un snapshot de contexte Claude',
    options: [
      {
        name: 'session_id',
        type: 3,
        description: 'ID de session (laisser vide pour le dernier)',
        required: false
      }
    ]
  },
  async execute(interaction) {
    await interaction.deferReply();

    const sessionId = interaction.options.getString('session_id') || 'latest';

    const snapshot = await mcp.call('pronexus.memory.get', { session_id: sessionId });

    // Cr√©er un thread pour afficher le contexte complet
    const thread = await interaction.channel.threads.create({
      name: `üì∏ Context Recall ‚Äî ${sessionId}`,
      autoArchiveDuration: 60,
      reason: `Recall demand√© par ${interaction.user.tag}`
    });

    await thread.send({
      embeds: [{
        title: "üß† Memory Snapshot",
        fields: [
          { name: "Session", value: snapshot.session_id, inline: true },
          { name: "Date", value: new Date(snapshot.timestamp).toLocaleString(), inline: true },
          { name: "Messages", value: snapshot.context.conversation.message_count.toString(), inline: true },
          { name: "T√¢ches actives", value: snapshot.context.state.active_tasks.join(', ') || 'Aucune' },
          { name: "Fichiers modifi√©s", value: snapshot.context.workspace.modified_files.join(', ') || 'Aucun' }
        ]
      }]
    });

    await interaction.editReply(`‚úÖ Snapshot affich√© dans le thread <#${thread.id}>`);
  }
};
```

**Commande : `/pnx-status`**

Affiche le statut global du syst√®me ProNeXus‚Ñ¢.

```javascript
// discord-bot/commands/pnx-status.js
module.exports = {
  data: {
    name: 'pnx-status',
    description: 'Statut global du syst√®me ProNeXus‚Ñ¢'
  },
  async execute(interaction) {
    const status = await mcp.call('pronexus.system.status');

    await interaction.reply({
      embeds: [{
        title: "üåê ProNeXus‚Ñ¢ System Status",
        color: 0x0099ff,
        fields: [
          {
            name: "ü§ñ Claude Bridge",
            value: status.claude_bridge.online ? '‚úÖ Online' : '‚ùå Offline',
            inline: true
          },
          {
            name: "üîó n8n Server",
            value: status.n8n.online ? '‚úÖ Online' : '‚ùå Offline',
            inline: true
          },
          {
            name: "üìù Notion API",
            value: status.notion.online ? '‚úÖ Online' : '‚ùå Offline',
            inline: true
          },
          {
            name: "üß† Memory Core",
            value: `${status.memory.snapshot_count} snapshots`,
            inline: true
          },
          {
            name: "‚ö° Workflows actifs",
            value: status.n8n.active_workflows.toString(),
            inline: true
          },
          {
            name: "üìä Uptime",
            value: status.uptime,
            inline: true
          }
        ],
        timestamp: new Date().toISOString()
      }]
    });
  }
};
```

### 5Ô∏è‚É£ Webhook Broadcasting depuis Claude

**MCP Tool : `discord.broadcast`**

```typescript
// mcp-server/tools/discord-broadcast.ts
export const discordBroadcast = {
  name: "discord_broadcast",
  description: "Envoie un message dans un canal Discord",
  inputSchema: {
    type: "object",
    properties: {
      channel: { type: "string", enum: ["ia_logs", "command_center", "notifications"] },
      message: { type: "string" },
      embed: { type: "object" }
    },
    required: ["channel", "message"]
  },
  handler: async ({ channel, message, embed }) => {
    const webhookUrl = config.discord.webhooks[channel];

    const payload = {
      content: message,
      embeds: embed ? [embed] : undefined
    };

    const response = await fetch(webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    return { success: response.ok, channel };
  }
};
```

**Utilisation depuis Claude Code :**

```bash
# Broadcast notification
claude-code mcp call discord_broadcast \
  --channel "notifications" \
  --message "üöÄ D√©ploiement termin√© : 5 nouvelles fiches publi√©es !" \
  --embed '{"color":65280,"fields":[{"name":"Fiches","value":"06, 07, 08, 09, 10"}]}'
```

### 6Ô∏è‚É£ Thread-Based Context Tracking

**Auto-cr√©ation de thread pour chaque session :**

```javascript
// Quand une nouvelle session Claude d√©marre
const createSessionThread = async (sessionId, initialContext) => {
  const channel = client.channels.cache.get(config.discord.channels.command_center);

  const thread = await channel.threads.create({
    name: `üß† Session ${sessionId}`,
    autoArchiveDuration: 1440, // 24h
    reason: 'Nouvelle session Claude Bridge'
  });

  await thread.send({
    embeds: [{
      title: "üöÄ Nouvelle Session Claude",
      description: `Session ID: \`${sessionId}\``,
      fields: [
        { name: "Projet", value: initialContext.workspace.working_directory },
        { name: "Branche", value: initialContext.workspace.git_branch },
        { name: "User", value: initialContext.metadata.user }
      ],
      color: 0x0099ff,
      timestamp: new Date().toISOString()
    }]
  });

  // Stocker le mapping session_id ‚Üí thread_id
  await redis.set(`session:${sessionId}:thread`, thread.id);

  return thread.id;
};
```

### 7Ô∏è‚É£ D√©marrage du Bot

**Fichier `discord-bot/index.js` :**

```javascript
const { Client, GatewayIntentBits, Collection } = require('discord.js');
const config = require('./config.json');

const client = new Client({
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildMessages,
    GatewayIntentBits.MessageContent
  ]
});

client.commands = new Collection();

// Charger les commandes
const commandFiles = fs.readdirSync('./commands').filter(f => f.endsWith('.js'));
for (const file of commandFiles) {
  const command = require(`./commands/${file}`);
  client.commands.set(command.data.name, command);
}

// Enregistrer les slash commands
client.once('ready', async () => {
  console.log(`‚úÖ Bot connect√© : ${client.user.tag}`);

  const commands = client.commands.map(cmd => cmd.data);
  await client.application.commands.set(commands, config.discord.guild_id);

  console.log(`üìù ${commands.length} slash commands enregistr√©es`);
});

// Handler interactions
client.on('interactionCreate', async interaction => {
  if (!interaction.isCommand()) return;

  const command = client.commands.get(interaction.commandName);
  if (!command) return;

  try {
    await command.execute(interaction);
  } catch (error) {
    console.error(error);
    await interaction.reply({ content: '‚ùå Erreur lors de l\'ex√©cution', ephemeral: true });
  }
});

client.login(config.discord.token);
```

**Lancement :**

```bash
cd discord-bot
npm install discord.js
node index.js

# Output:
# ‚úÖ Bot connect√© : ProNeXus Claude Bridge#1234
# üìù 3 slash commands enregistr√©es
```

---

## üíª Commandes / Snippets

### Auto-Log depuis Claude

```python
# Dans workflows Claude, logger automatiquement vers Discord
from claudebridge import DiscordLogger

logger = DiscordLogger(channel='ia_logs')

# Au d√©but d'une action
logger.start('notion.create_page')

# En cas de succ√®s
logger.success('notion.create_page', duration_ms=1240, details="Page cr√©√©e")

# En cas d'erreur
logger.error('notion.create_page', error="API rate limit exceeded")
```

### Notification de D√©ploiement

```bash
# Apr√®s publication des 5 fiches
claude-code mcp call discord_broadcast \
  --channel "notifications" \
  --message "@everyone üéâ **Forge Process PNX‚Ñ¢ compl√©t√©e !**" \
  --embed '{
    "color": 65280,
    "title": "‚úÖ FICHES 06-10 d√©ploy√©es",
    "fields": [
      {"name":"üìÑ Fiches","value":"5 nouvelles fiches Process"},
      {"name":"üîó Notion","value":"Base Fiches Process PNX‚Ñ¢ mise √† jour"},
      {"name":"‚è±Ô∏è Dur√©e","value":"12m 34s"}
    ]
  }'
```

### Monitoring des Erreurs

```javascript
// Auto-post des erreurs critiques
process.on('unhandledRejection', async (error) => {
  await discordBroadcast({
    channel: 'notifications',
    message: 'üö® **ERREUR CRITIQUE D√âTECT√âE**',
    embed: {
      color: 0xff0000,
      title: error.name,
      description: error.message,
      fields: [
        { name: 'Stack', value: `\`\`\`${error.stack.slice(0, 1000)}\`\`\`` }
      ]
    }
  });
});
```

---

## üì¶ Livrable officiel

**Chemin :** `docs/fiche-process/10.md`

**Synchronisations pr√©vues :**
- ‚úÖ Discord Bot "ProNeXus Claude Bridge"
- ‚úÖ Slash commands : `/pnx-execute`, `/pnx-recall`, `/pnx-status`
- ‚úÖ MCP tool `discord_broadcast`
- ‚úÖ Canaux Discord : #ia-logs, #command-center, #notifications

**Fichiers du bot :**
- `discord-bot/index.js` ‚Üí Point d'entr√©e
- `discord-bot/config.json` ‚Üí Configuration
- `discord-bot/commands/*.js` ‚Üí Commandes slash

**Variables d'environnement requises :**
- `DISCORD_BOT_TOKEN`
- `DISCORD_GUILD_ID`
- `DISCORD_WEBHOOK_URL_IA_LOGS`
- `DISCORD_WEBHOOK_URL_NOTIFICATIONS`

---

## üíé Niveau

**Avanc√©**

Requiert :
- D√©veloppement bot Discord (discord.js)
- Architecture webhook bidirectionnelle
- Int√©gration MCP tools
- Gestion embeds et threads Discord

---

## ‚úÖ Statut

**Public**

---

> **Fiche valid√©e ‚Äî ajout automatique √† la base Fiches Process PNX‚Ñ¢ (Notion / docs/fiche-process/10.md).**

---

*GalaXLytique‚Ñ¢ Process Documentation ‚Ä¢ ProNeXus AI Division ‚Ä¢ v1.0.0*
