# FICHE 08 — Claude ↔ n8n Full Bridge

## 🧩 Contexte & Objectif

Mise en place d'un **pont bidirectionnel complet** entre Claude Code et n8n, permettant l'orchestration d'automatisations depuis Claude et l'invocation de capacités Claude depuis workflows n8n. Architecture webhook sécurisée avec authentification token et logs d'exécution centralisés.

**Finalité opérationnelle :** Transformer Claude en orchestrateur d'automatisations n8n et exposer l'IA Claude comme service dans les workflows.

---

## ⚙️ Concepts Banger™

🔹 **Bidirectional Webhook Architecture**
Claude → n8n (trigger workflows) et n8n → Claude (invoquer IA via MCP).

🔹 **Token-Based Authentication**
Sécurisation des endpoints via Bearer tokens rotatifs et IP whitelisting.

🔹 **Execution Logging Pipeline**
Traçabilité complète des appels avec métadonnées (latence, payload size, status).

🔹 **Async Job Queue**
Exécution asynchrone des workflows lourds avec système de callback.

🔹 **Error Handling & Retry Logic**
Gestion intelligente des erreurs avec backoff exponentiel et dead letter queue.

---

## 🚀 Procédure complète

### 1️⃣ Configuration n8n — Endpoints Entrants

Créer workflow `Claude-Webhook-Receiver` :

**URL :** `https://n8n.pronexus.local/webhook/claude-bridge`

**Authentification :**
```json
{
  "method": "Bearer Token",
  "token": "pnx_n8n_{{ENV_TOKEN}}",
  "validation": "header"
}
```

**Nœuds du workflow :**
1. **Webhook Trigger** → Mode POST, JSON body
2. **Authentication Check** → Validation du token
3. **Router** → Dispatch selon `action` dans payload
4. **Executor Nodes** → Actions spécifiques (Notion write, Discord post, etc.)
5. **Logger** → Enregistrement dans base Execution Logs
6. **Response** → Retour JSON avec status

### 2️⃣ Format de Payload Claude → n8n

```json
{
  "bridge_version": "1.0",
  "source": "claude-code",
  "timestamp": "2025-10-30T15:00:00Z",
  "session_id": "ses_abc123",
  "auth": {
    "token": "pnx_n8n_secret_token",
    "user": "claude-bridge"
  },
  "action": "notion.create_page",
  "payload": {
    "database_id": "abc123def456",
    "properties": {
      "Title": { "title": [{ "text": { "content": "Nouvelle fiche" } }] },
      "Status": { "select": { "name": "Public" } }
    },
    "children": [
      {
        "object": "block",
        "type": "paragraph",
        "paragraph": {
          "rich_text": [{ "text": { "content": "Contenu de la fiche..." } }]
        }
      }
    ]
  },
  "options": {
    "async": true,
    "callback_url": "https://claude.pronexus.local/webhook/n8n-callback",
    "retry": {
      "enabled": true,
      "max_attempts": 3,
      "backoff": "exponential"
    }
  }
}
```

### 3️⃣ Configuration Claude MCP — Appel n8n

Dans le serveur MCP `claudebridge-pronexus`, créer tool :

```typescript
// mcp-server/tools/n8n-trigger.ts
export const n8nTrigger = {
  name: "trigger_n8n_workflow",
  description: "Déclenche un workflow n8n depuis Claude",
  inputSchema: {
    type: "object",
    properties: {
      workflow_id: { type: "string" },
      action: { type: "string" },
      payload: { type: "object" }
    },
    required: ["workflow_id", "action"]
  },
  handler: async (params) => {
    const response = await fetch('https://n8n.pronexus.local/webhook/claude-bridge', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${process.env.N8N_TOKEN}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        bridge_version: "1.0",
        source: "claude-code",
        timestamp: new Date().toISOString(),
        action: params.action,
        payload: params.payload,
        options: params.options || {}
      })
    });

    return await response.json();
  }
};
```

### 4️⃣ Reverse Bridge — n8n → Claude

Workflow n8n `Claude-AI-Invoker` :

**Use case :** Invoquer Claude depuis n8n pour génération de contenu.

**Nœuds :**
1. **Webhook Trigger** → Reçoit requête avec prompt
2. **HTTP Request** → Appel API Claude via MCP
   ```
   POST https://claude.pronexus.local/api/mcp/execute
   {
     "tool": "generate_content",
     "params": {
       "prompt": "{{ $json.prompt }}",
       "max_tokens": 4000
     }
   }
   ```
3. **Response Parser** → Extraction du contenu généré
4. **Post-Processing** → Formatage si nécessaire
5. **Return** → Renvoi vers appelant

### 5️⃣ Système de Logs d'Exécution

Créer base Notion `PNX-N8N-Execution-Logs` :

**Colonnes :**
- **Execution ID** (titre)
- **Timestamp** (date)
- **Source** (select: claude/n8n/discord)
- **Action** (text)
- **Status** (select: success/error/pending)
- **Duration (ms)** (number)
- **Payload Size (KB)** (number)
- **Error Message** (text)
- **Logs URL** (url)

**Insertion automatique depuis n8n :**
```javascript
// Dans nœud Logger
const logEntry = {
  "Execution ID": $node["Webhook"].json.execution_id,
  "Timestamp": new Date().toISOString(),
  "Source": "claude-code",
  "Action": $json.action,
  "Status": $json.status,
  "Duration (ms)": Date.now() - startTime,
  "Payload Size (KB)": JSON.stringify($json).length / 1024
};

await notion.createPage('pnx-n8n-execution-logs', logEntry);
```

### 6️⃣ Configuration Sécurité

**Fichier `.env` n8n :**
```bash
# Tokens d'authentification
N8N_CLAUDE_BRIDGE_TOKEN=pnx_n8n_prod_a1b2c3d4e5f6
N8N_ALLOWED_IPS=192.168.1.100,10.0.0.50

# Endpoints
CLAUDE_MCP_ENDPOINT=https://claude.pronexus.local/api/mcp
NOTION_API_KEY=secret_xxxxx
DISCORD_WEBHOOK_URL=https://discord.com/api/webhooks/xxxxx
```

**Fichier `~/.config/claude/bridge-config.json` :**
```json
{
  "n8n": {
    "endpoint": "https://n8n.pronexus.local/webhook/claude-bridge",
    "token": "pnx_n8n_prod_a1b2c3d4e5f6",
    "timeout": 30000,
    "retry": {
      "enabled": true,
      "max_attempts": 3,
      "delay": 1000
    }
  }
}
```

### 7️⃣ Test de Bout en Bout

**Depuis Claude Code :**
```bash
# Test trigger workflow
claude-code mcp call trigger_n8n_workflow \
  --workflow_id "claude-test" \
  --action "echo.test" \
  --payload '{"message":"Hello from Claude"}'

# Vérifier les logs
claude-code mcp call get_execution_logs \
  --limit 10
```

**Depuis n8n :**
```javascript
// Nœud HTTP Request — Test Claude invoke
POST https://claude.pronexus.local/api/mcp/execute
{
  "tool": "generate_content",
  "params": {
    "prompt": "Résume cette phrase : L'intelligence artificielle révolutionne l'automatisation."
  }
}
// Expected: { "content": "L'IA transforme l'automatisation.", ... }
```

---

## 💻 Commandes / Snippets

### Invocation Rapide depuis Claude

```python
# Dans un script Python via MCP
from claudebridge import N8NClient

n8n = N8NClient()

# Créer une page Notion via n8n
result = n8n.trigger(
    action="notion.create_page",
    payload={
        "database_id": "abc123",
        "properties": {
            "Title": {"title": [{"text": {"content": "Test page"}}]}
        }
    },
    async_mode=True
)

print(f"Execution ID: {result['execution_id']}")
print(f"Status: {result['status']}")
```

### Monitoring des Exécutions

```bash
# Récupérer les derniers logs
curl -H "Authorization: Bearer pnx_n8n_prod_xxx" \
  https://n8n.pronexus.local/api/executions?limit=20

# Filtrer par status
curl https://n8n.pronexus.local/api/executions?status=error
```

### Format de Callback Async

Lorsque `async: true`, n8n appellera le callback_url :

```json
{
  "execution_id": "exec_2025-10-30_xyz789",
  "status": "success",
  "started_at": "2025-10-30T15:00:00Z",
  "finished_at": "2025-10-30T15:00:12Z",
  "duration_ms": 12340,
  "result": {
    "notion_page_id": "abc123def456",
    "url": "https://notion.so/abc123def456"
  }
}
```

---

## 📦 Livrable officiel

**Chemin :** `docs/fiche-process/08.md`

**Synchronisations prévues :**
- ✅ Workflow n8n "Claude-Webhook-Receiver"
- ✅ Workflow n8n "Claude-AI-Invoker"
- ✅ MCP tool `trigger_n8n_workflow`
- ✅ Base Notion "PNX-N8N-Execution-Logs"

**Endpoints créés :**
- `POST /webhook/claude-bridge` → Trigger workflows depuis Claude
- `POST /api/mcp/execute` → Invoquer Claude depuis n8n
- `GET /api/executions` → Récupérer logs d'exécution

**Variables d'environnement requises :**
- `N8N_CLAUDE_BRIDGE_TOKEN`
- `CLAUDE_MCP_ENDPOINT`
- `N8N_ALLOWED_IPS`

---

## 💎 Niveau

**Avancé**

Requiert :
- Architecture webhook bidirectionnelle
- Maîtrise n8n workflows complexes
- Compréhension MCP server development
- Gestion authentification & sécurité

---

## ✅ Statut

**Public**

---

> **Fiche validée — ajout automatique à la base Fiches Process PNX™ (Notion / docs/fiche-process/08.md).**

---

*GalaXLytique™ Process Documentation • ProNeXus AI Division • v1.0.0*
