# FICHE 08 â€” Claude â†” n8n Full Bridge

## ðŸ§© Contexte & Objectif

Mise en place d'un **pont bidirectionnel complet** entre Claude Code et n8n, permettant l'orchestration d'automatisations depuis Claude et l'invocation de capacitÃ©s Claude depuis workflows n8n. Architecture webhook sÃ©curisÃ©e avec authentification token et logs d'exÃ©cution centralisÃ©s.

**FinalitÃ© opÃ©rationnelle :** Transformer Claude en orchestrateur d'automatisations n8n et exposer l'IA Claude comme service dans les workflows.

---

## âš™ï¸ Concepts Bangerâ„¢

ðŸ”¹ **Bidirectional Webhook Architecture**
Claude â†’ n8n (trigger workflows) et n8n â†’ Claude (invoquer IA via MCP).

ðŸ”¹ **Token-Based Authentication**
SÃ©curisation des endpoints via Bearer tokens rotatifs et IP whitelisting.

ðŸ”¹ **Execution Logging Pipeline**
TraÃ§abilitÃ© complÃ¨te des appels avec mÃ©tadonnÃ©es (latence, payload size, status).

ðŸ”¹ **Async Job Queue**
ExÃ©cution asynchrone des workflows lourds avec systÃ¨me de callback.

ðŸ”¹ **Error Handling & Retry Logic**
Gestion intelligente des erreurs avec backoff exponentiel et dead letter queue.

---

## ðŸš€ ProcÃ©dure complÃ¨te

### 1ï¸âƒ£ Configuration n8n â€” Endpoints Entrants

CrÃ©er workflow `Claude-Webhook-Receiver` :

**URL :** `https://n8n.pronexus.local/webhook/claude-bridge`

**Authentification :**
```json
{
  "method": "Bearer Token",
  "token": "pnx_n8n_{{ENV_TOKEN}}",
  "validation": "header"
}
```

**NÅ“uds du workflow :**
1. **Webhook Trigger** â†’ Mode POST, JSON body
2. **Authentication Check** â†’ Validation du token
3. **Router** â†’ Dispatch selon `action` dans payload
4. **Executor Nodes** â†’ Actions spÃ©cifiques (Notion write, Discord post, etc.)
5. **Logger** â†’ Enregistrement dans base Execution Logs
6. **Response** â†’ Retour JSON avec status

### 2ï¸âƒ£ Format de Payload Claude â†’ n8n

```json
{
  "bridge_version": "1.0",
  "source": "claude-code",
  "timestamp": "2025-10-30T15:00:00Z",
  "session_id": "ses_abc123",
  "auth": {
    "token": "pnx_n8n_secret_token",
    "user": "claude-bridge"
  },
  "action": "notion.create_page",
  "payload": {
    "database_id": "abc123def456",
    "properties": {
      "Title": { "title": [{ "text": { "content": "Nouvelle fiche" } }] },
      "Status": { "select": { "name": "Public" } }
    },
    "children": [
      {
        "object": "block",
        "type": "paragraph",
        "paragraph": {
          "rich_text": [{ "text": { "content": "Contenu de la fiche..." } }]
        }
      }
    ]
  },
  "options": {
    "async": true,
    "callback_url": "https://claude.pronexus.local/webhook/n8n-callback",
    "retry": {
      "enabled": true,
      "max_attempts": 3,
      "backoff": "exponential"
    }
  }
}
```

### 3ï¸âƒ£ Configuration Claude MCP â€” Appel n8n

Dans le serveur MCP `claudebridge-pronexus`, crÃ©er tool :

```typescript
// mcp-server/tools/n8n-trigger.ts
export const n8nTrigger = {
  name: "trigger_n8n_workflow",
  description: "DÃ©clenche un workflow n8n depuis Claude",
  inputSchema: {
    type: "object",
    properties: {
      workflow_id: { type: "string" },
      action: { type: "string" },
      payload: { type: "object" }
    },
    required: ["workflow_id", "action"]
  },
  handler: async (params) => {
    const response = await fetch('https://n8n.pronexus.local/webhook/claude-bridge', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${process.env.N8N_TOKEN}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        bridge_version: "1.0",
        source: "claude-code",
        timestamp: new Date().toISOString(),
        action: params.action,
        payload: params.payload,
        options: params.options || {}
      })
    });

    return await response.json();
  }
};
```

### 4ï¸âƒ£ Reverse Bridge â€” n8n â†’ Claude

Workflow n8n `Claude-AI-Invoker` :

**Use case :** Invoquer Claude depuis n8n pour gÃ©nÃ©ration de contenu.

**NÅ“uds :**
1. **Webhook Trigger** â†’ ReÃ§oit requÃªte avec prompt
2. **HTTP Request** â†’ Appel API Claude via MCP
   ```
   POST https://claude.pronexus.local/api/mcp/execute
   {
     "tool": "generate_content",
     "params": {
       "prompt": "{{ $json.prompt }}",
       "max_tokens": 4000
     }
   }
   ```
3. **Response Parser** â†’ Extraction du contenu gÃ©nÃ©rÃ©
4. **Post-Processing** â†’ Formatage si nÃ©cessaire
5. **Return** â†’ Renvoi vers appelant

### 5ï¸âƒ£ SystÃ¨me de Logs d'ExÃ©cution

CrÃ©er base Notion `PNX-N8N-Execution-Logs` :

**Colonnes :**
- **Execution ID** (titre)
- **Timestamp** (date)
- **Source** (select: claude/n8n/discord)
- **Action** (text)
- **Status** (select: success/error/pending)
- **Duration (ms)** (number)
- **Payload Size (KB)** (number)
- **Error Message** (text)
- **Logs URL** (url)

**Insertion automatique depuis n8n :**
```javascript
// Dans nÅ“ud Logger
const logEntry = {
  "Execution ID": $node["Webhook"].json.execution_id,
  "Timestamp": new Date().toISOString(),
  "Source": "claude-code",
  "Action": $json.action,
  "Status": $json.status,
  "Duration (ms)": Date.now() - startTime,
  "Payload Size (KB)": JSON.stringify($json).length / 1024
};

await notion.createPage('pnx-n8n-execution-logs', logEntry);
```

### 6ï¸âƒ£ Configuration SÃ©curitÃ©

**Fichier `.env` n8n :**
```bash
# Tokens d'authentification
N8N_CLAUDE_BRIDGE_TOKEN=pnx_n8n_prod_a1b2c3d4e5f6
N8N_ALLOWED_IPS=192.168.1.100,10.0.0.50

# Endpoints
CLAUDE_MCP_ENDPOINT=https://claude.pronexus.local/api/mcp
NOTION_API_KEY=secret_xxxxx
DISCORD_WEBHOOK_URL=https://discord.com/api/webhooks/xxxxx
```

**Fichier `~/.config/claude/bridge-config.json` :**
```json
{
  "n8n": {
    "endpoint": "https://n8n.pronexus.local/webhook/claude-bridge",
    "token": "pnx_n8n_prod_a1b2c3d4e5f6",
    "timeout": 30000,
    "retry": {
      "enabled": true,
      "max_attempts": 3,
      "delay": 1000
    }
  }
}
```

### 7ï¸âƒ£ Test de Bout en Bout

**Depuis Claude Code :**
```bash
# Test trigger workflow
claude-code mcp call trigger_n8n_workflow \
  --workflow_id "claude-test" \
  --action "echo.test" \
  --payload '{"message":"Hello from Claude"}'

# VÃ©rifier les logs
claude-code mcp call get_execution_logs \
  --limit 10
```

**Depuis n8n :**
```javascript
// NÅ“ud HTTP Request â€” Test Claude invoke
POST https://claude.pronexus.local/api/mcp/execute
{
  "tool": "generate_content",
  "params": {
    "prompt": "RÃ©sume cette phrase : L'intelligence artificielle rÃ©volutionne l'automatisation."
  }
}
// Expected: { "content": "L'IA transforme l'automatisation.", ... }
```

---

## ðŸ’» Commandes / Snippets

### Invocation Rapide depuis Claude

```python
# Dans un script Python via MCP
from claudebridge import N8NClient

n8n = N8NClient()

# CrÃ©er une page Notion via n8n
result = n8n.trigger(
    action="notion.create_page",
    payload={
        "database_id": "abc123",
        "properties": {
            "Title": {"title": [{"text": {"content": "Test page"}}]}
        }
    },
    async_mode=True
)

print(f"Execution ID: {result['execution_id']}")
print(f"Status: {result['status']}")
```

### Monitoring des ExÃ©cutions

```bash
# RÃ©cupÃ©rer les derniers logs
curl -H "Authorization: Bearer pnx_n8n_prod_xxx" \
  https://n8n.pronexus.local/api/executions?limit=20

# Filtrer par status
curl https://n8n.pronexus.local/api/executions?status=error
```

### Format de Callback Async

Lorsque `async: true`, n8n appellera le callback_url :

```json
{
  "execution_id": "exec_2025-10-30_xyz789",
  "status": "success",
  "started_at": "2025-10-30T15:00:00Z",
  "finished_at": "2025-10-30T15:00:12Z",
  "duration_ms": 12340,
  "result": {
    "notion_page_id": "abc123def456",
    "url": "https://notion.so/abc123def456"
  }
}
```

---

## ðŸ“¦ Livrable officiel

**Chemin :** `docs/fiche-process/08.md`

**Synchronisations prÃ©vues :**
- âœ… Workflow n8n "Claude-Webhook-Receiver"
- âœ… Workflow n8n "Claude-AI-Invoker"
- âœ… MCP tool `trigger_n8n_workflow`
- âœ… Base Notion "PNX-N8N-Execution-Logs"

**Endpoints crÃ©Ã©s :**
- `POST /webhook/claude-bridge` â†’ Trigger workflows depuis Claude
- `POST /api/mcp/execute` â†’ Invoquer Claude depuis n8n
- `GET /api/executions` â†’ RÃ©cupÃ©rer logs d'exÃ©cution

**Variables d'environnement requises :**
- `N8N_CLAUDE_BRIDGE_TOKEN`
- `CLAUDE_MCP_ENDPOINT`
- `N8N_ALLOWED_IPS`

---

## ðŸ’Ž Niveau

**AvancÃ©**

Requiert :
- Architecture webhook bidirectionnelle
- MaÃ®trise n8n workflows complexes
- ComprÃ©hension MCP server development
- Gestion authentification & sÃ©curitÃ©

---

## âœ… Statut

**Public**

---

> **Fiche validÃ©e â€” ajout automatique Ã  la base Fiches Process PNXâ„¢ (Notion / docs/fiche-process/08.md).**

---

*GalaXLytiqueâ„¢ Process Documentation â€¢ ProNeXus AI Division â€¢ v1.0.0*
