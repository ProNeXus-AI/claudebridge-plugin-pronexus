# FICHE 09 ‚Äî Notion Sync Ultimate‚Ñ¢

## üß© Contexte & Objectif

Impl√©mentation d'un **syst√®me de synchronisation bidirectionnelle** entre Claude Bridge et Notion, permettant lecture automatique de bases existantes et √©criture directe de nouvelles pages avec formatage riche. Architecture optimis√©e pour manipulation de structures complexes (databases, relations, blocks imbriqu√©s).

**Finalit√© op√©rationnelle :** Faire de Notion le syst√®me de fichiers documentaire de Claude, avec acc√®s transparent en lecture/√©criture.

---

## ‚öôÔ∏è Concepts Banger‚Ñ¢

üîπ **Schema-Aware Sync**
D√©tection automatique des propri√©t√©s de base Notion (types, options select, relations) pour validation des donn√©es.

üîπ **Block Tree Builder**
Constructeur de hi√©rarchies de blocks Notion (paragraphes, headings, code, callouts, etc.) depuis Markdown.

üîπ **Bi-Directional Mapping**
Conversion r√©versible Notion ‚Üî Markdown avec pr√©servation des m√©tadonn√©es.

üîπ **Batch Operations**
Optimisation des appels API via batching (cr√©er 10 pages en 1 requ√™te composite).

üîπ **Real-Time Validation**
V√©rification pr√©-publication des schemas pour √©viter les erreurs API Notion.

---

## üöÄ Proc√©dure compl√®te

### 1Ô∏è‚É£ Configuration API Notion

**Cr√©er une int√©gration :**
1. Aller sur https://www.notion.so/my-integrations
2. Cr√©er "ProNeXus Claude Bridge"
3. Copier le token : `secret_xxxxx`
4. Donner acc√®s aux bases requises

**Fichier `~/.config/claude/notion-config.json` :**
```json
{
  "notion": {
    "api_key": "secret_xxxxx",
    "version": "2022-06-28",
    "databases": {
      "fiches_process": "2990a77e973480fcade1cc37ef1c24a4",
      "memory_snapshots": "abc123def456",
      "execution_logs": "xyz789abc123"
    },
    "rate_limit": {
      "requests_per_second": 3,
      "batch_size": 10
    }
  }
}
```

### 2Ô∏è‚É£ Extraction du Schema de Base

**MCP Tool : `notion.get_database_schema`**

```typescript
// Dans MCP server
export const getDatabaseSchema = {
  name: "notion_get_database_schema",
  description: "R√©cup√®re le schema complet d'une database Notion",
  inputSchema: {
    type: "object",
    properties: {
      database_id: { type: "string" }
    },
    required: ["database_id"]
  },
  handler: async ({ database_id }) => {
    const notion = new Client({ auth: process.env.NOTION_API_KEY });
    const db = await notion.databases.retrieve({ database_id });

    return {
      id: db.id,
      title: db.title[0]?.plain_text || "Untitled",
      properties: Object.entries(db.properties).map(([name, prop]) => ({
        name,
        type: prop.type,
        // Pour select/multi_select : options disponibles
        options: prop.type === "select" ? prop.select.options : undefined,
        // Pour relation : database cible
        relation_database: prop.type === "relation" ? prop.relation.database_id : undefined
      }))
    };
  }
};
```

**Exemple de r√©ponse :**
```json
{
  "id": "2990a77e973480fcade1cc37ef1c24a4",
  "title": "Fiches Process PNX",
  "properties": [
    {
      "name": "Nom du Process",
      "type": "title"
    },
    {
      "name": "Description",
      "type": "rich_text"
    },
    {
      "name": "Statut",
      "type": "select",
      "options": [
        { "name": "Public", "color": "green" },
        { "name": "Draft", "color": "gray" }
      ]
    },
    {
      "name": "Niveau",
      "type": "select",
      "options": [
        { "name": "D√©butant", "color": "blue" },
        { "name": "Interm√©diaire", "color": "yellow" },
        { "name": "Avanc√©", "color": "orange" },
        { "name": "Expert", "color": "red" }
      ]
    },
    {
      "name": "Lien",
      "type": "url"
    }
  ]
}
```

### 3Ô∏è‚É£ Lecture de Pages Existantes

**MCP Tool : `notion.query_database`**

```typescript
export const queryDatabase = {
  name: "notion_query_database",
  description: "Requ√™te une database Notion avec filtres",
  inputSchema: {
    type: "object",
    properties: {
      database_id: { type: "string" },
      filter: { type: "object" },
      sorts: { type: "array" }
    },
    required: ["database_id"]
  },
  handler: async ({ database_id, filter, sorts }) => {
    const notion = new Client({ auth: process.env.NOTION_API_KEY });
    const response = await notion.databases.query({
      database_id,
      filter,
      sorts: sorts || [{ timestamp: "created_time", direction: "descending" }]
    });

    return response.results.map(page => ({
      id: page.id,
      url: page.url,
      properties: extractProperties(page.properties),
      created_time: page.created_time,
      last_edited_time: page.last_edited_time
    }));
  }
};
```

**Exemple d'utilisation depuis Claude :**
```bash
# R√©cup√©rer toutes les fiches "Public"
claude-code mcp call notion_query_database \
  --database_id "2990a77e973480fcade1cc37ef1c24a4" \
  --filter '{"property":"Statut","select":{"equals":"Public"}}'
```

### 4Ô∏è‚É£ Cr√©ation de Page avec Contenu Riche

**Format de donn√©es pour publication :**

```json
{
  "database_id": "2990a77e973480fcade1cc37ef1c24a4",
  "properties": {
    "Nom du Process": {
      "title": [
        {
          "text": {
            "content": "FICHE 06 ‚Äî Claude Bridge ProNeXus‚Ñ¢ Forge Ops"
          }
        }
      ]
    },
    "Description": {
      "rich_text": [
        {
          "text": {
            "content": "Activation de la Forge Assist√©e ClaudeBridge v2.0..."
          }
        }
      ]
    },
    "Statut": {
      "select": {
        "name": "Public"
      }
    },
    "Niveau": {
      "select": {
        "name": "Avanc√©"
      }
    }
  },
  "children": [
    {
      "object": "block",
      "type": "heading_2",
      "heading_2": {
        "rich_text": [{ "text": { "content": "üß© Contexte & Objectif" } }]
      }
    },
    {
      "object": "block",
      "type": "paragraph",
      "paragraph": {
        "rich_text": [{ "text": { "content": "Activation et d√©ploiement complet..." } }]
      }
    },
    {
      "object": "block",
      "type": "code",
      "code": {
        "language": "bash",
        "rich_text": [{ "text": { "content": "claude-code plugin install ./claude-plugin" } }]
      }
    },
    {
      "object": "block",
      "type": "callout",
      "callout": {
        "icon": { "emoji": "üíé" },
        "rich_text": [{ "text": { "content": "Niveau : Avanc√©" } }]
      }
    }
  ]
}
```

### 5Ô∏è‚É£ Convertisseur Markdown ‚Üí Notion Blocks

**Algorithme de parsing :**

```python
# Dans mcp-server/converters/md_to_notion.py
def markdown_to_notion_blocks(markdown_content):
    blocks = []
    lines = markdown_content.split('\n')

    for line in lines:
        # Headings
        if line.startswith('## '):
            blocks.append({
                "type": "heading_2",
                "heading_2": {"rich_text": [{"text": {"content": line[3:]}}]}
            })
        elif line.startswith('### '):
            blocks.append({
                "type": "heading_3",
                "heading_3": {"rich_text": [{"text": {"content": line[4:]}}]}
            })

        # Code blocks
        elif line.startswith('```'):
            language = line[3:].strip() or "plain text"
            code_content = extract_code_block(lines, index)
            blocks.append({
                "type": "code",
                "code": {
                    "language": language,
                    "rich_text": [{"text": {"content": code_content}}]
                }
            })

        # Bullet lists
        elif line.startswith('- ') or line.startswith('* '):
            blocks.append({
                "type": "bulleted_list_item",
                "bulleted_list_item": {
                    "rich_text": [{"text": {"content": line[2:]}}]
                }
            })

        # Numbered lists
        elif re.match(r'^\d+\. ', line):
            blocks.append({
                "type": "numbered_list_item",
                "numbered_list_item": {
                    "rich_text": [{"text": {"content": re.sub(r'^\d+\. ', '', line)}}]
                }
            })

        # Paragraphs
        elif line.strip():
            blocks.append({
                "type": "paragraph",
                "paragraph": {"rich_text": [{"text": {"content": line}}]}
            })

    return blocks
```

### 6Ô∏è‚É£ Skill Claude : `notion-publish`

**Fichier `skills/notion-publish.SKILL.md` :**

````markdown
# Notion Publisher

Publie automatiquement des fiches GalaXLytique‚Ñ¢ vers Notion.

## Utilisation

/skill notion-publish

## Comportement

1. D√©tecte les fichiers `.md` dans `docs/fiche-process/`
2. Parse le Markdown en blocks Notion
3. Extrait les m√©tadonn√©es (titre, niveau, statut)
4. Valide contre le schema de la database
5. Cr√©e la page Notion
6. Retourne l'URL de la page cr√©√©e

## Exemple

```bash
# Publier la FICHE 06
claude-code skill run notion-publish --file docs/fiche-process/06.md

# Output:
# ‚úÖ Page cr√©√©e : FICHE 06 ‚Äî Claude Bridge ProNeXus‚Ñ¢ Forge Ops
# üîó URL: https://notion.so/2990a77e97348...
# üìä Statut: Public | Niveau: Avanc√©
```
````

### 7Ô∏è‚É£ Test de Publication Compl√®te

```bash
# Test depuis Claude Code
claude-code skill run notion-publish \
  --database "fiches_process" \
  --file "docs/fiche-process/06.md" \
  --dry-run false

# V√©rification
claude-code mcp call notion_query_database \
  --database_id "2990a77e973480fcade1cc37ef1c24a4" \
  --filter '{"property":"Nom du Process","title":{"contains":"FICHE 06"}}'
```

**Validation dans Notion :**
- Ouvrir la base "Fiches Process PNX‚Ñ¢"
- V√©rifier pr√©sence de la nouvelle page
- Confirmer formatage (headings, code blocks, emojis)
- Tester les propri√©t√©s (Statut, Niveau)

---

## üíª Commandes / Snippets

### Batch Publication de Fiches

```python
# Script de publication massive
from claudebridge import NotionPublisher
import glob

publisher = NotionPublisher(database_id="2990a77e973480fcade1cc37ef1c24a4")

fiches = glob.glob("docs/fiche-process/*.md")
results = []

for fiche_path in fiches:
    result = publisher.publish(
        file_path=fiche_path,
        auto_extract_metadata=True,
        validate_schema=True
    )
    results.append(result)
    print(f"‚úÖ {result['title']} ‚Üí {result['url']}")

print(f"\nüìä {len(results)} fiches publi√©es avec succ√®s")
```

### Synchronisation Incr√©mentale

```typescript
// Sync uniquement les fiches modifi√©es
const syncIncremental = async () => {
  const localFiles = await glob("docs/fiche-process/*.md");
  const notionPages = await notion.queryDatabase(databaseId);

  for (const file of localFiles) {
    const localModified = fs.statSync(file).mtime;
    const notionPage = notionPages.find(p =>
      p.properties["Nom du Process"].includes(path.basename(file, '.md'))
    );

    if (!notionPage || new Date(notionPage.last_edited_time) < localModified) {
      console.log(`üîÑ Sync needed: ${file}`);
      await publisher.publish(file);
    }
  }
};
```

### Extraction de M√©tadonn√©es depuis Markdown

```javascript
// Parser les propri√©t√©s depuis le contenu Markdown
const extractMetadata = (markdownContent) => {
  const titleMatch = markdownContent.match(/^# (FICHE \d+ ‚Äî .+)$/m);
  const niveauMatch = markdownContent.match(/\*\*(.+?)\*\*/);
  const statutMatch = markdownContent.match(/## ‚úÖ Statut\n\n\*\*(.+?)\*\*/);

  return {
    title: titleMatch?.[1] || "Sans titre",
    niveau: niveauMatch?.[1] || "Interm√©diaire",
    statut: statutMatch?.[1] || "Draft"
  };
};
```

---

## üì¶ Livrable officiel

**Chemin :** `docs/fiche-process/09.md`

**Synchronisations pr√©vues :**
- ‚úÖ Skill Claude `notion-publish`
- ‚úÖ MCP tools : `notion_get_database_schema`, `notion_query_database`, `notion_create_page`
- ‚úÖ Converter `md_to_notion.py`
- ‚úÖ Script de batch sync `sync_all_fiches.sh`

**Bases Notion configur√©es :**
- **Fiches Process PNX‚Ñ¢** (`2990a77e973480fcade1cc37ef1c24a4`)
- **PNX Memory Snapshots**
- **PNX Execution Logs**

**Tests requis :**
- Publication d'une fiche simple (texte + headings)
- Publication avec code blocks et emojis
- Publication avec callouts et listes
- Batch publication des 5 fiches (06-10)

---

## üíé Niveau

**Avanc√©**

Requiert :
- Ma√Ætrise API Notion (databases, blocks, properties)
- Parsing Markdown avanc√©
- Gestion schemas dynamiques
- Optimisation rate limiting

---

## ‚úÖ Statut

**Public**

---

> **Fiche valid√©e ‚Äî ajout automatique √† la base Fiches Process PNX‚Ñ¢ (Notion / docs/fiche-process/09.md).**

---

*GalaXLytique‚Ñ¢ Process Documentation ‚Ä¢ ProNeXus AI Division ‚Ä¢ v1.0.0*
