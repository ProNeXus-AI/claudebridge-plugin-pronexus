# FICHE 09 â€” Notion Sync Ultimateâ„¢

## ðŸ§© Contexte & Objectif

ImplÃ©mentation d'un **systÃ¨me de synchronisation bidirectionnelle** entre Claude Bridge et Notion, permettant lecture automatique de bases existantes et Ã©criture directe de nouvelles pages avec formatage riche. Architecture optimisÃ©e pour manipulation de structures complexes (databases, relations, blocks imbriquÃ©s).

**FinalitÃ© opÃ©rationnelle :** Faire de Notion le systÃ¨me de fichiers documentaire de Claude, avec accÃ¨s transparent en lecture/Ã©criture.

---

## âš™ï¸ Concepts Bangerâ„¢

ðŸ”¹ **Schema-Aware Sync**
DÃ©tection automatique des propriÃ©tÃ©s de base Notion (types, options select, relations) pour validation des donnÃ©es.

ðŸ”¹ **Block Tree Builder**
Constructeur de hiÃ©rarchies de blocks Notion (paragraphes, headings, code, callouts, etc.) depuis Markdown.

ðŸ”¹ **Bi-Directional Mapping**
Conversion rÃ©versible Notion â†” Markdown avec prÃ©servation des mÃ©tadonnÃ©es.

ðŸ”¹ **Batch Operations**
Optimisation des appels API via batching (crÃ©er 10 pages en 1 requÃªte composite).

ðŸ”¹ **Real-Time Validation**
VÃ©rification prÃ©-publication des schemas pour Ã©viter les erreurs API Notion.

---

## ðŸš€ ProcÃ©dure complÃ¨te

### 1ï¸âƒ£ Configuration API Notion

**CrÃ©er une intÃ©gration :**
1. Aller sur https://www.notion.so/my-integrations
2. CrÃ©er "ProNeXus Claude Bridge"
3. Copier le token : `secret_xxxxx`
4. Donner accÃ¨s aux bases requises

**Fichier `~/.config/claude/notion-config.json` :**
```json
{
  "notion": {
    "api_key": "secret_xxxxx",
    "version": "2022-06-28",
    "databases": {
      "fiches_process": "2990a77e973480fcade1cc37ef1c24a4",
      "memory_snapshots": "abc123def456",
      "execution_logs": "xyz789abc123"
    },
    "rate_limit": {
      "requests_per_second": 3,
      "batch_size": 10
    }
  }
}
```

### 2ï¸âƒ£ Extraction du Schema de Base

**MCP Tool : `notion.get_database_schema`**

```typescript
// Dans MCP server
export const getDatabaseSchema = {
  name: "notion_get_database_schema",
  description: "RÃ©cupÃ¨re le schema complet d'une database Notion",
  inputSchema: {
    type: "object",
    properties: {
      database_id: { type: "string" }
    },
    required: ["database_id"]
  },
  handler: async ({ database_id }) => {
    const notion = new Client({ auth: process.env.NOTION_API_KEY });
    const db = await notion.databases.retrieve({ database_id });

    return {
      id: db.id,
      title: db.title[0]?.plain_text || "Untitled",
      properties: Object.entries(db.properties).map(([name, prop]) => ({
        name,
        type: prop.type,
        // Pour select/multi_select : options disponibles
        options: prop.type === "select" ? prop.select.options : undefined,
        // Pour relation : database cible
        relation_database: prop.type === "relation" ? prop.relation.database_id : undefined
      }))
    };
  }
};
```

**Exemple de rÃ©ponse :**
```json
{
  "id": "2990a77e973480fcade1cc37ef1c24a4",
  "title": "Fiches Process PNX",
  "properties": [
    {
      "name": "Nom du Process",
      "type": "title"
    },
    {
      "name": "Description",
      "type": "rich_text"
    },
    {
      "name": "Statut",
      "type": "select",
      "options": [
        { "name": "Public", "color": "green" },
        { "name": "Draft", "color": "gray" }
      ]
    },
    {
      "name": "Niveau",
      "type": "select",
      "options": [
        { "name": "DÃ©butant", "color": "blue" },
        { "name": "IntermÃ©diaire", "color": "yellow" },
        { "name": "AvancÃ©", "color": "orange" },
        { "name": "Expert", "color": "red" }
      ]
    },
    {
      "name": "Lien",
      "type": "url"
    }
  ]
}
```

### 3ï¸âƒ£ Lecture de Pages Existantes

**MCP Tool : `notion.query_database`**

```typescript
export const queryDatabase = {
  name: "notion_query_database",
  description: "RequÃªte une database Notion avec filtres",
  inputSchema: {
    type: "object",
    properties: {
      database_id: { type: "string" },
      filter: { type: "object" },
      sorts: { type: "array" }
    },
    required: ["database_id"]
  },
  handler: async ({ database_id, filter, sorts }) => {
    const notion = new Client({ auth: process.env.NOTION_API_KEY });
    const response = await notion.databases.query({
      database_id,
      filter,
      sorts: sorts || [{ timestamp: "created_time", direction: "descending" }]
    });

    return response.results.map(page => ({
      id: page.id,
      url: page.url,
      properties: extractProperties(page.properties),
      created_time: page.created_time,
      last_edited_time: page.last_edited_time
    }));
  }
};
```

**Exemple d'utilisation depuis Claude :**
```bash
# RÃ©cupÃ©rer toutes les fiches "Public"
claude-code mcp call notion_query_database \
  --database_id "2990a77e973480fcade1cc37ef1c24a4" \
  --filter '{"property":"Statut","select":{"equals":"Public"}}'
```

### 4ï¸âƒ£ CrÃ©ation de Page avec Contenu Riche

**Format de donnÃ©es pour publication :**

```json
{
  "database_id": "2990a77e973480fcade1cc37ef1c24a4",
  "properties": {
    "Nom du Process": {
      "title": [
        {
          "text": {
            "content": "FICHE 06 â€” Claude Bridge ProNeXusâ„¢ Forge Ops"
          }
        }
      ]
    },
    "Description": {
      "rich_text": [
        {
          "text": {
            "content": "Activation de la Forge AssistÃ©e ClaudeBridge v2.0..."
          }
        }
      ]
    },
    "Statut": {
      "select": {
        "name": "Public"
      }
    },
    "Niveau": {
      "select": {
        "name": "AvancÃ©"
      }
    }
  },
  "children": [
    {
      "object": "block",
      "type": "heading_2",
      "heading_2": {
        "rich_text": [{ "text": { "content": "ðŸ§© Contexte & Objectif" } }]
      }
    },
    {
      "object": "block",
      "type": "paragraph",
      "paragraph": {
        "rich_text": [{ "text": { "content": "Activation et dÃ©ploiement complet..." } }]
      }
    },
    {
      "object": "block",
      "type": "code",
      "code": {
        "language": "bash",
        "rich_text": [{ "text": { "content": "claude-code plugin install ./claude-plugin" } }]
      }
    },
    {
      "object": "block",
      "type": "callout",
      "callout": {
        "icon": { "emoji": "ðŸ’Ž" },
        "rich_text": [{ "text": { "content": "Niveau : AvancÃ©" } }]
      }
    }
  ]
}
```

### 5ï¸âƒ£ Convertisseur Markdown â†’ Notion Blocks

**Algorithme de parsing :**

```python
# Dans mcp-server/converters/md_to_notion.py
def markdown_to_notion_blocks(markdown_content):
    blocks = []
    lines = markdown_content.split('\n')

    for line in lines:
        # Headings
        if line.startswith('## '):
            blocks.append({
                "type": "heading_2",
                "heading_2": {"rich_text": [{"text": {"content": line[3:]}}]}
            })
        elif line.startswith('### '):
            blocks.append({
                "type": "heading_3",
                "heading_3": {"rich_text": [{"text": {"content": line[4:]}}]}
            })

        # Code blocks
        elif line.startswith('```'):
            language = line[3:].strip() or "plain text"
            code_content = extract_code_block(lines, index)
            blocks.append({
                "type": "code",
                "code": {
                    "language": language,
                    "rich_text": [{"text": {"content": code_content}}]
                }
            })

        # Bullet lists
        elif line.startswith('- ') or line.startswith('* '):
            blocks.append({
                "type": "bulleted_list_item",
                "bulleted_list_item": {
                    "rich_text": [{"text": {"content": line[2:]}}]
                }
            })

        # Numbered lists
        elif re.match(r'^\d+\. ', line):
            blocks.append({
                "type": "numbered_list_item",
                "numbered_list_item": {
                    "rich_text": [{"text": {"content": re.sub(r'^\d+\. ', '', line)}}]
                }
            })

        # Paragraphs
        elif line.strip():
            blocks.append({
                "type": "paragraph",
                "paragraph": {"rich_text": [{"text": {"content": line}}]}
            })

    return blocks
```

### 6ï¸âƒ£ Skill Claude : `notion-publish`

**Fichier `skills/notion-publish.SKILL.md` :**

````markdown
# Notion Publisher

Publie automatiquement des fiches GalaXLytiqueâ„¢ vers Notion.

## Utilisation

/skill notion-publish

## Comportement

1. DÃ©tecte les fichiers `.md` dans `docs/fiche-process/`
2. Parse le Markdown en blocks Notion
3. Extrait les mÃ©tadonnÃ©es (titre, niveau, statut)
4. Valide contre le schema de la database
5. CrÃ©e la page Notion
6. Retourne l'URL de la page crÃ©Ã©e

## Exemple

```bash
# Publier la FICHE 06
claude-code skill run notion-publish --file docs/fiche-process/06.md

# Output:
# âœ… Page crÃ©Ã©e : FICHE 06 â€” Claude Bridge ProNeXusâ„¢ Forge Ops
# ðŸ”— URL: https://notion.so/2990a77e97348...
# ðŸ“Š Statut: Public | Niveau: AvancÃ©
```
````

### 7ï¸âƒ£ Test de Publication ComplÃ¨te

```bash
# Test depuis Claude Code
claude-code skill run notion-publish \
  --database "fiches_process" \
  --file "docs/fiche-process/06.md" \
  --dry-run false

# VÃ©rification
claude-code mcp call notion_query_database \
  --database_id "2990a77e973480fcade1cc37ef1c24a4" \
  --filter '{"property":"Nom du Process","title":{"contains":"FICHE 06"}}'
```

**Validation dans Notion :**
- Ouvrir la base "Fiches Process PNXâ„¢"
- VÃ©rifier prÃ©sence de la nouvelle page
- Confirmer formatage (headings, code blocks, emojis)
- Tester les propriÃ©tÃ©s (Statut, Niveau)

---

## ðŸ’» Commandes / Snippets

### Batch Publication de Fiches

```python
# Script de publication massive
from claudebridge import NotionPublisher
import glob

publisher = NotionPublisher(database_id="2990a77e973480fcade1cc37ef1c24a4")

fiches = glob.glob("docs/fiche-process/*.md")
results = []

for fiche_path in fiches:
    result = publisher.publish(
        file_path=fiche_path,
        auto_extract_metadata=True,
        validate_schema=True
    )
    results.append(result)
    print(f"âœ… {result['title']} â†’ {result['url']}")

print(f"\nðŸ“Š {len(results)} fiches publiÃ©es avec succÃ¨s")
```

### Synchronisation IncrÃ©mentale

```typescript
// Sync uniquement les fiches modifiÃ©es
const syncIncremental = async () => {
  const localFiles = await glob("docs/fiche-process/*.md");
  const notionPages = await notion.queryDatabase(databaseId);

  for (const file of localFiles) {
    const localModified = fs.statSync(file).mtime;
    const notionPage = notionPages.find(p =>
      p.properties["Nom du Process"].includes(path.basename(file, '.md'))
    );

    if (!notionPage || new Date(notionPage.last_edited_time) < localModified) {
      console.log(`ðŸ”„ Sync needed: ${file}`);
      await publisher.publish(file);
    }
  }
};
```

### Extraction de MÃ©tadonnÃ©es depuis Markdown

```javascript
// Parser les propriÃ©tÃ©s depuis le contenu Markdown
const extractMetadata = (markdownContent) => {
  const titleMatch = markdownContent.match(/^# (FICHE \d+ â€” .+)$/m);
  const niveauMatch = markdownContent.match(/\*\*(.+?)\*\*/);
  const statutMatch = markdownContent.match(/## âœ… Statut\n\n\*\*(.+?)\*\*/);

  return {
    title: titleMatch?.[1] || "Sans titre",
    niveau: niveauMatch?.[1] || "IntermÃ©diaire",
    statut: statutMatch?.[1] || "Draft"
  };
};
```

---

## ðŸ“¦ Livrable officiel

**Chemin :** `docs/fiche-process/09.md`

**Synchronisations prÃ©vues :**
- âœ… Skill Claude `notion-publish`
- âœ… MCP tools : `notion_get_database_schema`, `notion_query_database`, `notion_create_page`
- âœ… Converter `md_to_notion.py`
- âœ… Script de batch sync `sync_all_fiches.sh`

**Bases Notion configurÃ©es :**
- **Fiches Process PNXâ„¢** (`2990a77e973480fcade1cc37ef1c24a4`)
- **PNX Memory Snapshots**
- **PNX Execution Logs**

**Tests requis :**
- Publication d'une fiche simple (texte + headings)
- Publication avec code blocks et emojis
- Publication avec callouts et listes
- Batch publication des 5 fiches (06-10)

---

## ðŸ’Ž Niveau

**AvancÃ©**

Requiert :
- MaÃ®trise API Notion (databases, blocks, properties)
- Parsing Markdown avancÃ©
- Gestion schemas dynamiques
- Optimisation rate limiting

---

## âœ… Statut

**Public**

---

> **Fiche validÃ©e â€” ajout automatique Ã  la base Fiches Process PNXâ„¢ (Notion / docs/fiche-process/09.md).**

---

*GalaXLytiqueâ„¢ Process Documentation â€¢ ProNeXus AI Division â€¢ v1.0.0*
