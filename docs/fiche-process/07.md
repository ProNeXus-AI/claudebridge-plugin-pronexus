# FICHE 07 â€” PNX Memory Sync Coreâ„¢

## ğŸ§© Contexte & Objectif

ImplÃ©mentation du **protocole de mÃ©moire distribuÃ©e** permettant la synchronisation contextuelle entre Claude, Notion, Discord et n8n. Cette architecture garantit la persistance et l'accessibilitÃ© du contexte conversationnel Ã  travers l'ensemble de l'Ã©cosystÃ¨me ProNeXusâ„¢.

**FinalitÃ© opÃ©rationnelle :** CrÃ©er une source de vÃ©ritÃ© unifiÃ©e pour le contexte IA, accessible depuis tous les points d'entrÃ©e du systÃ¨me.

---

## âš™ï¸ Concepts Bangerâ„¢

ğŸ”¹ **Unified Context Protocol (UCP)**
Format JSON standardisÃ© pour reprÃ©senter l'Ã©tat complet d'une session Claude (conversation, fichiers, metadata).

ğŸ”¹ **Snapshot Architecture**
Captures temporelles immuables du contexte, versionnÃ©es et stockÃ©es dans Notion.

ğŸ”¹ **Multi-Channel Sync**
Propagation bidirectionnelle du contexte entre Claude Code, Notion Database, Discord threads et workflows n8n.

ğŸ”¹ **Context Compression**
Algorithme de rÃ©duction intelligente du contexte pour optimiser le stockage et la transmission.

ğŸ”¹ **Hot Memory Layer**
Cache Redis-like pour accÃ¨s ultra-rapide au contexte rÃ©cent (< 5ms).

---

## ğŸš€ ProcÃ©dure complÃ¨te

### 1ï¸âƒ£ Initialisation du Memory Core

```bash
# CrÃ©er la base Notion pour les snapshots
# URL: https://notion.so/pnx-memory-snapshots

# Structure requise :
# - Session ID (titre)
# - Timestamp (date)
# - Context JSON (code block)
# - Status (select: active/archived)
# - Source (select: claude/discord/n8n)
```

### 2ï¸âƒ£ Configuration du Format Snapshot

Le format **UCP (Unified Context Protocol)** :

```json
{
  "snapshot_version": "1.0",
  "session_id": "ses_2025-10-30_abc123",
  "timestamp": "2025-10-30T14:23:45Z",
  "source": "claude-code",
  "context": {
    "conversation": {
      "messages": [
        {
          "role": "user",
          "content": "...",
          "timestamp": "2025-10-30T14:20:00Z"
        },
        {
          "role": "assistant",
          "content": "...",
          "timestamp": "2025-10-30T14:20:15Z",
          "tools_used": ["Read", "Write"]
        }
      ],
      "message_count": 12
    },
    "workspace": {
      "working_directory": "/home/user/project",
      "git_branch": "feature/memory-sync",
      "recent_files": [
        "src/main.py",
        "docs/api.md"
      ],
      "modified_files": ["src/main.py"]
    },
    "metadata": {
      "model": "claude-sonnet-4-5",
      "total_tokens": 45230,
      "session_duration": "1h 23m",
      "user": "dev@pronexus.ai"
    },
    "state": {
      "active_tasks": ["Implement memory sync", "Update docs"],
      "completed_tasks": ["Setup database", "Configure MCP"],
      "blockers": []
    }
  },
  "compression": {
    "enabled": true,
    "algorithm": "pnx-context-v1",
    "original_size": 125000,
    "compressed_size": 28400
  }
}
```

### 3ï¸âƒ£ Capture Automatique via /pnxsnap

```bash
# Dans Claude Code
/pnxsnap

# GÃ©nÃ¨re automatiquement :
# 1. Snapshot UCP complet
# 2. Publication dans Notion
# 3. Broadcast Discord (canal #ia-logs)
# 4. Trigger n8n workflow "memory-index"
```

### 4ï¸âƒ£ Configuration n8n Memory Workflow

CrÃ©er workflow `PNX-Memory-Sync` :

**Trigger:** Webhook `https://n8n.pronexus.local/webhook/memory-sync`

**NÅ“uds :**
1. **Webhook Receiver** â†’ ReÃ§oit snapshot UCP
2. **JSON Parser** â†’ Validation du format
3. **Notion Writer** â†’ Insertion dans base Memory
4. **Discord Notifier** â†’ Post dans #memory-logs
5. **Redis Cache** â†’ Stockage hot memory (TTL: 24h)

### 5ï¸âƒ£ RÃ©cupÃ©ration du Contexte

```javascript
// Via MCP tool dans Claude Code
const context = await mcp.call('pronexus.memory.get', {
  session_id: 'ses_2025-10-30_abc123'
});

// Ou via API n8n
const response = await fetch('https://n8n.pronexus.local/api/memory/latest');
const snapshot = await response.json();
```

### 6ï¸âƒ£ Synchronisation Discord â†” Memory

**Slash command Discord :**
```
/pnx-recall [session_id]
```

Renvoie le snapshot formatÃ© avec :
- RÃ©sumÃ© conversation (5 derniers messages)
- TÃ¢ches actives
- Fichiers modifiÃ©s
- Lien Notion vers snapshot complet

### 7ï¸âƒ£ Validation de la Sync

```bash
# Test complet du pipeline
curl -X POST https://n8n.pronexus.local/webhook/memory-sync \
  -H "Content-Type: application/json" \
  -d @test-snapshot.json

# VÃ©rifier dans Notion
# VÃ©rifier log Discord
# VÃ©rifier cache Redis
```

---

## ğŸ’» Commandes / Snippets

### GÃ©nÃ©ration Snapshot Manuelle

```python
# Dans un script Python
from claudebridge import MemoryCore

memory = MemoryCore()
snapshot = memory.create_snapshot(
    session_id="custom_session_123",
    include_files=True,
    compress=True
)

# Publish to all channels
memory.sync(snapshot, channels=["notion", "discord", "n8n"])
```

### RequÃªte Hot Memory (Redis)

```javascript
// Via n8n Function node
const redis = $node["Redis"].getConnection();
const key = `pnx:memory:${sessionId}`;
const cached = await redis.get(key);

if (cached) {
  return JSON.parse(cached);
}
// Fallback vers Notion si non en cache
```

### Format de Compression

```json
{
  "compression": {
    "enabled": true,
    "algorithm": "pnx-context-v1",
    "rules": {
      "remove_duplicates": true,
      "summarize_long_messages": {
        "threshold": 500,
        "method": "claude-summary"
      },
      "exclude_system_reminders": true,
      "binary_encoding": "base64"
    }
  }
}
```

---

## ğŸ“¦ Livrable officiel

**Chemin :** `docs/fiche-process/07.md`

**Synchronisations prÃ©vues :**
- âœ… Base Notion "PNX Memory Snapshots"
- âœ… Workflow n8n "PNX-Memory-Sync"
- âœ… Discord slash command `/pnx-recall`
- âœ… MCP tool `pronexus.memory.*`

**Bases Notion requises :**
- **PNX Memory Snapshots** (URL fournie par utilisateur)
- Colonnes : Session ID, Timestamp, Context JSON, Status, Source

**Endpoints n8n requis :**
- `POST /webhook/memory-sync` â†’ Ingestion snapshot
- `GET /api/memory/latest` â†’ RÃ©cupÃ©ration dernier snapshot
- `GET /api/memory/{session_id}` â†’ RÃ©cupÃ©ration snapshot spÃ©cifique

---

## ğŸ’ Niveau

**AvancÃ©**

Requiert :
- Architecture distribuÃ©e
- MaÃ®trise API Notion
- Workflows n8n complexes
- ComprÃ©hension protocoles de sÃ©rialisation

---

## âœ… Statut

**Public**

---

> **Fiche validÃ©e â€” ajout automatique Ã  la base Fiches Process PNXâ„¢ (Notion / docs/fiche-process/07.md).**

---

*GalaXLytiqueâ„¢ Process Documentation â€¢ ProNeXus AI Division â€¢ v1.0.0*
