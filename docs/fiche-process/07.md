# FICHE 07 — PNX Memory Sync Core™

## 🧩 Contexte & Objectif

Implémentation du **protocole de mémoire distribuée** permettant la synchronisation contextuelle entre Claude, Notion, Discord et n8n. Cette architecture garantit la persistance et l'accessibilité du contexte conversationnel à travers l'ensemble de l'écosystème ProNeXus™.

**Finalité opérationnelle :** Créer une source de vérité unifiée pour le contexte IA, accessible depuis tous les points d'entrée du système.

---

## ⚙️ Concepts Banger™

🔹 **Unified Context Protocol (UCP)**
Format JSON standardisé pour représenter l'état complet d'une session Claude (conversation, fichiers, metadata).

🔹 **Snapshot Architecture**
Captures temporelles immuables du contexte, versionnées et stockées dans Notion.

🔹 **Multi-Channel Sync**
Propagation bidirectionnelle du contexte entre Claude Code, Notion Database, Discord threads et workflows n8n.

🔹 **Context Compression**
Algorithme de réduction intelligente du contexte pour optimiser le stockage et la transmission.

🔹 **Hot Memory Layer**
Cache Redis-like pour accès ultra-rapide au contexte récent (< 5ms).

---

## 🚀 Procédure complète

### 1️⃣ Initialisation du Memory Core

```bash
# Créer la base Notion pour les snapshots
# URL: https://notion.so/pnx-memory-snapshots

# Structure requise :
# - Session ID (titre)
# - Timestamp (date)
# - Context JSON (code block)
# - Status (select: active/archived)
# - Source (select: claude/discord/n8n)
```

### 2️⃣ Configuration du Format Snapshot

Le format **UCP (Unified Context Protocol)** :

```json
{
  "snapshot_version": "1.0",
  "session_id": "ses_2025-10-30_abc123",
  "timestamp": "2025-10-30T14:23:45Z",
  "source": "claude-code",
  "context": {
    "conversation": {
      "messages": [
        {
          "role": "user",
          "content": "...",
          "timestamp": "2025-10-30T14:20:00Z"
        },
        {
          "role": "assistant",
          "content": "...",
          "timestamp": "2025-10-30T14:20:15Z",
          "tools_used": ["Read", "Write"]
        }
      ],
      "message_count": 12
    },
    "workspace": {
      "working_directory": "/home/user/project",
      "git_branch": "feature/memory-sync",
      "recent_files": [
        "src/main.py",
        "docs/api.md"
      ],
      "modified_files": ["src/main.py"]
    },
    "metadata": {
      "model": "claude-sonnet-4-5",
      "total_tokens": 45230,
      "session_duration": "1h 23m",
      "user": "dev@pronexus.ai"
    },
    "state": {
      "active_tasks": ["Implement memory sync", "Update docs"],
      "completed_tasks": ["Setup database", "Configure MCP"],
      "blockers": []
    }
  },
  "compression": {
    "enabled": true,
    "algorithm": "pnx-context-v1",
    "original_size": 125000,
    "compressed_size": 28400
  }
}
```

### 3️⃣ Capture Automatique via /pnxsnap

```bash
# Dans Claude Code
/pnxsnap

# Génère automatiquement :
# 1. Snapshot UCP complet
# 2. Publication dans Notion
# 3. Broadcast Discord (canal #ia-logs)
# 4. Trigger n8n workflow "memory-index"
```

### 4️⃣ Configuration n8n Memory Workflow

Créer workflow `PNX-Memory-Sync` :

**Trigger:** Webhook `https://n8n.pronexus.local/webhook/memory-sync`

**Nœuds :**
1. **Webhook Receiver** → Reçoit snapshot UCP
2. **JSON Parser** → Validation du format
3. **Notion Writer** → Insertion dans base Memory
4. **Discord Notifier** → Post dans #memory-logs
5. **Redis Cache** → Stockage hot memory (TTL: 24h)

### 5️⃣ Récupération du Contexte

```javascript
// Via MCP tool dans Claude Code
const context = await mcp.call('pronexus.memory.get', {
  session_id: 'ses_2025-10-30_abc123'
});

// Ou via API n8n
const response = await fetch('https://n8n.pronexus.local/api/memory/latest');
const snapshot = await response.json();
```

### 6️⃣ Synchronisation Discord ↔ Memory

**Slash command Discord :**
```
/pnx-recall [session_id]
```

Renvoie le snapshot formaté avec :
- Résumé conversation (5 derniers messages)
- Tâches actives
- Fichiers modifiés
- Lien Notion vers snapshot complet

### 7️⃣ Validation de la Sync

```bash
# Test complet du pipeline
curl -X POST https://n8n.pronexus.local/webhook/memory-sync \
  -H "Content-Type: application/json" \
  -d @test-snapshot.json

# Vérifier dans Notion
# Vérifier log Discord
# Vérifier cache Redis
```

---

## 💻 Commandes / Snippets

### Génération Snapshot Manuelle

```python
# Dans un script Python
from claudebridge import MemoryCore

memory = MemoryCore()
snapshot = memory.create_snapshot(
    session_id="custom_session_123",
    include_files=True,
    compress=True
)

# Publish to all channels
memory.sync(snapshot, channels=["notion", "discord", "n8n"])
```

### Requête Hot Memory (Redis)

```javascript
// Via n8n Function node
const redis = $node["Redis"].getConnection();
const key = `pnx:memory:${sessionId}`;
const cached = await redis.get(key);

if (cached) {
  return JSON.parse(cached);
}
// Fallback vers Notion si non en cache
```

### Format de Compression

```json
{
  "compression": {
    "enabled": true,
    "algorithm": "pnx-context-v1",
    "rules": {
      "remove_duplicates": true,
      "summarize_long_messages": {
        "threshold": 500,
        "method": "claude-summary"
      },
      "exclude_system_reminders": true,
      "binary_encoding": "base64"
    }
  }
}
```

---

## 📦 Livrable officiel

**Chemin :** `docs/fiche-process/07.md`

**Synchronisations prévues :**
- ✅ Base Notion "PNX Memory Snapshots"
- ✅ Workflow n8n "PNX-Memory-Sync"
- ✅ Discord slash command `/pnx-recall`
- ✅ MCP tool `pronexus.memory.*`

**Bases Notion requises :**
- **PNX Memory Snapshots** (URL fournie par utilisateur)
- Colonnes : Session ID, Timestamp, Context JSON, Status, Source

**Endpoints n8n requis :**
- `POST /webhook/memory-sync` → Ingestion snapshot
- `GET /api/memory/latest` → Récupération dernier snapshot
- `GET /api/memory/{session_id}` → Récupération snapshot spécifique

---

## 💎 Niveau

**Avancé**

Requiert :
- Architecture distribuée
- Maîtrise API Notion
- Workflows n8n complexes
- Compréhension protocoles de sérialisation

---

## ✅ Statut

**Public**

---

> **Fiche validée — ajout automatique à la base Fiches Process PNX™ (Notion / docs/fiche-process/07.md).**

---

*GalaXLytique™ Process Documentation • ProNeXus AI Division • v1.0.0*
